{{- if .Values.postSyncHook.enabled }}
# ArgoCD PostSync hook: patch TargetGroupBinding.spec.targetGroupARN from ConfigMap (bootstrap-output).
apiVersion: batch/v1
kind: Job
metadata:
  name: post-sync-patch-targetgroupbinding
  namespace: {{ .Values.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: post-sync-patch-tgb
      restartPolicy: OnFailure
      containers:
        - name: patch
          image: {{ .Values.postSyncHook.image }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              ARN=$(kubectl get configmap {{ .Values.postSyncHook.bootstrapConfigMap.name }} -n {{ .Values.postSyncHook.bootstrapConfigMap.namespace }} -o jsonpath='{.data.{{ .Values.postSyncHook.bootstrapConfigMap.key }}}')
              if [ -z "$ARN" ]; then
                echo "ConfigMap {{ .Values.postSyncHook.bootstrapConfigMap.namespace }}/{{ .Values.postSyncHook.bootstrapConfigMap.name }} key {{ .Values.postSyncHook.bootstrapConfigMap.key }} is empty, skipping patch"
                exit 0
              fi
              kubectl patch targetgroupbinding {{ .Values.app.name }} -n {{ .Values.namespace }} --type=merge -p "{\"spec\":{\"targetGroupARN\":\"$ARN\"}}"
              echo "Patched TargetGroupBinding {{ .Values.app.name }} with $ARN from {{ .Values.postSyncHook.bootstrapConfigMap.namespace }}/{{ .Values.postSyncHook.bootstrapConfigMap.name }}"
              CURRENT=$(kubectl get targetgroupbinding -n rosa-regional-frontend rosa-regional-frontend -ojson | jq -r '.spec.targetGroupARN')
              if [ "PLACEHOLDER" == "$CURRENT" ]; then
                echo "TargetGroupBinding {{ .Values.app.name }} still has PLACEHOLDER, exiting with error"
                exit 1
              fi
{{- end }}
